<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ausgaben (Version 103.12.25</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: sans-serif; background-color: #f7fafc; color: #000000; }
    input[type="number"]::-webkit-inner-spin-button { opacity: 1; }

    @media print {
      body {
        background-color: #ffffff;
      }
      body * {
        visibility: hidden !important;
      }
      #printArea, #printArea * {
        visibility: visible !important;
      }
      #printArea {
        position: absolute;
        inset: 0;
        margin: 0;
        padding: 16px;
        background: #ffffff;
      }
    }
  
    input {
      color: #111111;
    }

    .text-gray-600,
    .text-gray-700,
    .text-gray-800,
    .text-gray-900 {
      color: #000000 !important;
    }

    td input, td, .text-gray-600, .text-gray-700, .text-gray-800, .text-gray-900 {
        font-weight:500 !important;
        color:#000000 !important;
    }

    td input, td {
        font-weight:700 !important;
        color:#000000 !important;
    }

    td input, td, td span {
        font-weight:700 !important;
        color:#000000 !important;
    }

    .monthYear {
      font-weight: 700 !important;
      color: #000000 !important;
    }
</style>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body class="p-6 bg-gray-100 text-gray-800">
  <div class="max-w-4xl mx-auto bg-white rounded-xl shadow p-6">
    <div class="flex justify-between items-center mb-4">
      <h1 class="text-2xl font-bold flex items-center gap-2">
      <span class="text-2xl">üìä</span>
      <span>Ausgaben</span>
      <select id="monthSelect" class="border rounded px-2 py-1 text-sm">
        <option value="">(Monat w√§hlen)</option>
        <option value="01">Januar</option>
        <option value="02">Februar</option>
        <option value="03">M√§rz</option>
        <option value="04">April</option>
        <option value="05">Mai</option>
        <option value="06">Juni</option>
        <option value="07">Juli</option>
        <option value="08">August</option>
        <option value="09">September</option>
        <option value="10">Oktober</option>
        <option value="11">November</option>
        <option value="12">Dezember</option>
      </select>
      
<button id="lockIcon" class="text-xl px-2" title="Monat ist entsperrt ‚Äì Klick zum Sperren">üîì</button>

      <select id="yearSelect" class="border rounded px-2 py-1 text-sm">
      </select>
    </h1>
      <span class="text-sm text-gray-500">Version 103.12.25</span>
    </div>

    <div class="flex gap-2 mb-4">
      <button id="printBtn" class="bg-gray-600 text-white px-4 py-2 rounded">Drucken</button>
      
      <button id="importBtn" class="bg-yellow-500 text-white px-4 py-2 rounded">Daten laden</button>
      <button id="exportBtn" class="bg-indigo-600 text-white px-4 py-2 rounded">Datei speichern</button>
<button id="excelExportBtn" class="bg-purple-600 text-white px-4 py-2 rounded">üìÑ Excel speichern</button>
      
    </div>

    <div id="printArea"></div>

    <table class="w-full border text-sm" id="expenseTable">
      <thead class="bg-gray-100">
        <tr>
          <th class="p-2 border">Beleg</th>
          <th class="p-2 border">Datum</th>
          <th class="p-2 border">Betrag (‚Ç¨)</th>
          <th class="p-2 border">Beschreibung</th>
          <th class="p-2 border">Aktion</th>
        </tr>
      </thead>
      <tbody id="expenseBody"></tbody>
      <tfoot>
        
<tr id="enterHintRow" style="display:none;">
  <td></td>
  <td colspan="3" class="text-center text-gray-700 text-sm">Enter f√ºr neue Zeile ‚Äì f√ºr mehrere Positionen im selben Beleg kein Datum angeben</td>
</tr>
<tr>
          <td class="border-t p-1"></td>
          <td class="border-t p-1 align-top">
            <div class="text-sm space-y-1">
              <div class="flex justify-between">
                <strong>Gesamtsumme (Brutto):</strong>
                <span id="total" class="ml-4"> 0.00</span>
              </div>
              <div class="flex justify-between">
                <strong>Nettobetrag:</strong>
                <span id="net" class="ml-4"> 0.00</span>
              </div>
              <div class="flex justify-between">
                <strong>Mehrwertsteuer (19%):</strong>
                <span id="vat" class="ml-4"> 0.00</span>
              </div>
            </div>
          </td>
          <td class="border-t p-1"></td>
          <td class="border-t p-1"></td>
        </tr>
      </tfoot>
    </table>

    <div class="mt-1 flex justify-end">
      <div id="enterHint" class="text-sm text-gray-600" style="display:none; width:60%; text-align:center;">
        Enter f√ºr neue Zeile ‚Äì f√ºr mehrere Positionen im selben Beleg kein Datum angeben
      </div>
    </div>
    <div class="mt-4 text-right">
      <button id="clearAllBtn" class="bg-red-600 text-white px-4 py-2 rounded">üóëÔ∏è Diesen Monat l√∂schen</button>
    </div>

    <input type="file" id="importInput" accept=".json" style="display:none" />
  </div>

  <script>
    let expenses = [];
    let sortDirection = 'desc';

    const expenseBody = document.getElementById('expenseBody');
    const totalDisplay = document.getElementById('total');
    const netDisplay = document.getElementById('net');
    const vatDisplay = document.getElementById('vat');
    const printArea = document.getElementById('printArea');
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');

    
let allExpenses = {};
let currentKey = '';

function getCurrentKey() {
  const month = monthSelect?.value || '';
  const year = yearSelect?.value || '';
  return (month && year) ? `${year}-${month}` : '';
}

function saveAll() {
  localStorage.setItem('all_expenses', JSON.stringify(allExpenses));
}

function saveCurrentMonth() {
  if (!currentKey) return;
  allExpenses[currentKey] = expenses;
  saveAll();
}

function loadAll() {
  const data = localStorage.getItem('all_expenses');
  if (data) {
    try {
      allExpenses = JSON.parse(data);
    } catch {
      allExpenses = {};
    }
  } else {
    allExpenses = {};
  }
}



let lockedMonths = {};

function loadLocks() {
  const raw = localStorage.getItem('locked_months');
  if (raw) {
    try {
      lockedMonths = JSON.parse(raw);
    } catch {
      lockedMonths = {};
    }
  }
}

function saveLocks() {
  localStorage.setItem('locked_months', JSON.stringify(lockedMonths));
}

function isLocked(key) {
  return lockedMonths[key] === true;
}

function toggleLock() {
  if (!currentKey) return;
  lockedMonths[currentKey] = !isLocked(currentKey);
  saveLocks();
  updateLockIcon();
  updateEditability();
}

function updateLockIcon() {
  const icon = document.getElementById('lockIcon');
  if (!icon) return;
  icon.textContent = isLocked(currentKey) ? 'üîí' : 'üîì';
  icon.title = isLocked(currentKey) ? 'Monat ist gesperrt ‚Äì Klick zum Entsperren' : 'Monat ist entsperrt ‚Äì Klick zum Sperren';
}

function updateEditability() {
  const locked = isLocked(currentKey);

  document.querySelectorAll('#expenseTable input').forEach(input => {
    input.readOnly = locked;
    input.disabled = locked;
  });

  // Row delete buttons
  document.querySelectorAll('.deleteBtn').forEach(btn => {
    btn.style.display = locked ? 'none' : '';
  });

  // Import is blocked when locked
  const importBtn = document.getElementById('importBtn');
  if (importBtn) importBtn.disabled = locked;

  // Hide the "Diesen Monat l√∂schen" button completely when locked
  const clearBtn = document.getElementById('clearAllBtn');
  if (clearBtn) {
    clearBtn.disabled = locked;
    clearBtn.style.display = locked ? 'none' : '';
  }
}


const MONTH_NAMES = {
      "01": "Januar",
      "02": "Februar",
      "03": "M√§rz",
      "04": "April",
      "05": "Mai",
      "06": "Juni",
      "07": "Juli",
      "08": "August",
      "09": "September",
      "10": "Oktober",
      "11": "November",
      "12": "Dezember"
    };

    function determineMonthFromExpenses() {
      if (!Array.isArray(expenses) || expenses.length === 0) return;
      for (const exp of expenses) {
        if (!exp || !exp.date || typeof exp.date !== 'string') continue;
        const parts = exp.date.split('-');
        if (parts.length === 3) {
          const y = parts[0];
          const m = parts[1];
          if (yearSelect) {
            yearSelect.value = y;
          }
          if (monthSelect && monthSelect.querySelector(`option[value="${m}"]`)) {
            monthSelect.value = m;
          }
          return;
        }
      }
    }

    function initMonthSelector() {
      const now = new Date();
      const currentMonth = String(now.getMonth() + 1).padStart(2, '0');
      const currentYear = now.getFullYear();

      if (yearSelect) {
        yearSelect.innerHTML = '';
        for (let y = currentYear - 5; y <= currentYear + 5; y++) {
          const opt = document.createElement('option');
          opt.value = String(y);
          opt.textContent = String(y);
          yearSelect.appendChild(opt);
        }
        yearSelect.value = String(currentYear);
      }

      if (monthSelect) {
        if (monthSelect.querySelector(`option[value="${currentMonth}"]`)) {
          monthSelect.value = currentMonth;
        }
      }

      // Versuche, Monat/Jahr aus vorhandenen Eintr√§gen zu √ºbernehmen
      determineMonthFromExpenses();
    }

    function save() {
      saveCurrentMonth();
    }

    function parseAmount(value) {
      if (typeof value !== 'string') {
        value = String(value ?? '');
      }
      value = value.trim();
      if (!value) return 0;

      const hasComma = value.includes(',');
      const hasDot = value.includes('.');

      if (hasComma && hasDot) {
        value = value.replace(/\./g, '').replace(',', '.');
      } else if (hasComma && !hasDot) {
        value = value.replace(',', '.');
      }
      const n = parseFloat(value);
      return isNaN(n) ? 0 : n;
    }

    function getNextReceiptNumber() {
      let max = 0;
      if (Array.isArray(expenses)) {
        expenses.forEach(exp => {
          if (!exp || exp.receipt === undefined || exp.receipt === null) return;
          const n = parseInt(exp.receipt, 10);
          if (!isNaN(n) && n > max) {
            max = n;
          }
        });
      }
      return String(max + 1);
    }

    function autoAssignReceiptsIfMissing() {
      if (!Array.isArray(expenses)) return;
      // Nur f√ºr Zeilen ohne Belegnummer UND mit Datum (Tag) in aktueller Reihenfolge
      let counter = 1;
      expenses.forEach(exp => {
        if (!exp) return;
        const current = (exp.receipt || '').toString().trim();

        // Datum pr√ºfen: nur wenn ein Tag vorhanden ist (iso-Format YYYY-MM-DD erwartet)
        const d = (exp.date || '').toString().trim();
        let hasDay = false;
        if (d) {
          const parts = d.split('-');
          if (parts.length === 3 && parts[2]) {
            hasDay = true;
          }
        }

        if (!hasDay) {
          // F√ºr Zeilen ohne Datum niemals eine Belegnummer vergeben
          return;
        }

        if (!current) {
          exp.receipt = String(counter++);
        } else {
          // Wenn bereits Nummern existieren, Z√§hler hinter die gr√∂√üte Nummer setzen
          const n = parseInt(current, 10);
          if (!isNaN(n) && n >= counter) {
            counter = n + 1;
          }
        }
      });
    }


    function recalcTotals() {
      let total = 0;

      expenses.forEach(exp => {
        total += parseAmount(exp.amount);
      });

      const net = total / 1.19;
      const vat = total - net;

      totalDisplay.textContent = formatEuro(total);
      netDisplay.textContent = formatEuro(net);
      vatDisplay.textContent = formatEuro(vat);
    }


    function getDateParts(iso) {
      let day = '';
      if (iso && typeof iso === 'string') {
        const parts = iso.split('-');
        if (parts.length === 3) {
          day = parts[2];
        }
      }
      const now = new Date();
      const year = (yearSelect && yearSelect.value)
        ? yearSelect.value
        : String(now.getFullYear());
      const month = (monthSelect && monthSelect.value)
        ? monthSelect.value
        : String(now.getMonth() + 1).padStart(2, '0');
      return { year, month, day };
    }

    function buildDateFromDay(dayInput, existingIso) {
      let day = String(dayInput || '').replace(/\D/g, '');
      if (!day) return existingIso || '';
      if (day.length === 1) {
        day = '0' + day;
      }
      const parts = getDateParts(existingIso);
      const year = parts.year;
      const month = parts.month;
      return `${year}-${month}-${day}`;
    }

    function render() {
      expenseBody.innerHTML = '';

      expenses.forEach((exp, index) => {
        const row = document.createElement('tr');
        const parts = getDateParts(exp.date);
        const day = parts.day ? String(parseInt(parts.day, 10)) : '';
        const monthYearLabel = (exp.hideDate && !day) ? '' : (parts.month && parts.year ? ` .${parts.month}.${parts.year}` : '');
        const dateStyle = (exp.hideDate && !day) ? 'visibility:hidden' : '';

        row.innerHTML = `
          <td class="border p-1 w-20">
            <input
              type="text"
              inputmode="numeric"
              value="${exp.receipt || ''}"
              class="w-full p-1 text-right bg-gray-50"
              readonly
              tabindex="-1"
            />
          </td>
          <td class="border p-1">
            <div class="flex items-center gap-1">
              <input
                type="text"
                inputmode="numeric"
                value="${day}"
                data-index="${index}"
                data-field="date"
                style="${dateStyle}"
                class="w-16 p-1 text-right"
              />
              <span class="monthYear">${monthYearLabel}</span>
            </div>
          </td>
          <td class="border p-1 w-28">
            <input
              type="text"
              inputmode="decimal"
              placeholder="0,00"
              value="${exp.amount || ''}"
              data-index="${index}"
              data-field="amount"
              class="w-full p-1 text-right"
            />
          </td>
          <td class="border p-1">
            <input
              type="text"
              value="${exp.desc || ''}"
              data-index="${index}"
              data-field="desc"
              class="w-[400px] p-1"
            />
          </td>
          <td class="border p-1 text-center">
            <div class="flex justify-center">
              ${index === 0
                ? ""
                : `<button
                    data-index="${index}"
                    class="deleteBtn text-red-600"
                    title="Zeile l√∂schen"
                  >
                    üóëÔ∏è
                  </button>`
              }
            </div>
          </td>
        `;
        expenseBody.appendChild(row);
      });

      recalcTotals();
    }

    function formatDateGerman(iso) {
      if (!iso) return '';
      const parts = iso.split('-');
      if (parts.length !== 3) return iso;
      const [y, m, d] = parts;
      return `${d}.${m}.${y}`;
    }

    function getSelectedMonthName() {
      if (!monthSelect) return '';
      const val = monthSelect.value;
      if (!val) return '';
      return MONTH_NAMES[val] || '';
    }

    function getSelectedYear() {
      if (!yearSelect) return '';
      const val = yearSelect.value;
      if (!val) return '';
      return val;
    }

    function getPrintTitle() {
      const monthName = getSelectedMonthName();
      const year = getSelectedYear();
      if (monthName && year) return `Ausgaben ‚Äì ${monthName} ${year}`;
      if (monthName) return `Ausgaben ‚Äì ${monthName}`;
      if (year) return `Ausgaben ‚Äì ${year}`;
      return 'Ausgaben';
    }

    function buildPrintArea() {
      if (!printArea) return;

      const title = getPrintTitle();

      const rows = expenses || [];

      let rowsHtml = '';
      rows.forEach(exp => {
        const date = formatDateGerman(exp.date);
        const amountNumber = parseAmount(exp.amount);
        const amountFormatted = amountNumber ? (Math.round(amountNumber*100)/100).toFixed(2).replace('.', ',') : '';
        const desc = exp.desc || '';
        const receipt = exp.receipt || '';
        rowsHtml += `
          <tr>
            <td style="padding:2px 4px;width:60px;text-align:right;">${receipt}</td>
            <td style="padding:2px 4px;width:80px;">${date}</td>
            <td style="padding:2px 8px;text-align:right;width:100px;">${amountFormatted}</td>
            <td style="padding:2px 4px 2px 20px;">${desc}</td>
          </tr>
        `;
      });

      // Summen √ºber alle Eintr√§ge berechnen (wie auf der Hauptseite)
      recalcTotals();
      const totalText = totalDisplay.textContent;
      const netText = netDisplay.textContent;
      const vatText = vatDisplay.textContent;

      const totalPlain = totalText.replace('‚Ç¨','').trim();
const netPlain = netText.replace('‚Ç¨','').trim();
const vatPlain = vatText.replace('‚Ç¨','').trim();
const summaryRows = rows.length ? `
        <tr>
          <td colspan="2" style="padding:40px 4px 4px 4px;font-weight:bold;">Gesamtsumme (Brutto gesamt):</td>
          <td style="padding:40px 4px 4px 4px;text-align:right;">${totalPlain}</td>
          <td style="padding:40px 4px 4px 4px;"></td>
        </tr>
        <tr>
          <td colspan="2" style="padding:4px;font-weight:bold;">Nettobetrag (gesamt):</td>
          <td style="padding:4px;text-align:right;">${netPlain}</td>
          <td style="padding:4px;"></td>
        </tr>
        <tr>
          <td colspan="2" style="padding:4px;font-weight:bold;">Mehrwertsteuer (19 % gesamt):</td>
          <td style="padding:4px;text-align:right;">${vatPlain}</td>
          <td style="padding:4px;"></td>
        </tr>
      ` : '';

      printArea.innerHTML = `
        <h1 style="font-size:22px;font-weight:bold;margin-bottom:14px;">${title}</h1>
        <table style="width:100%;border-collapse:collapse;margin-bottom:12px;font-size:14px;">
          <thead>
            <tr>
              <th style="padding:4px;text-align:left;width:60px;">Beleg</th>
              <th style="padding:4px;text-align:left;width:80px;">Datum</th>
              <th style="padding:4px;text-align:right;width:100px;">Betrag</th>
              <th style="padding:4px 4px 4px 20px;text-align:left;">Beschreibung</th>
            </tr>
          </thead>
          <tbody>
            ${rowsHtml || `<tr><td colspan="4" style="padding:4px;font-style:italic;">Keine Eintr√§ge.</td></tr>`}
            ${summaryRows}
          </tbody>
        </table>
      `;
    }


    expenseBody.addEventListener('change', (e) => {
      const index = e.target.dataset.index;
      const field = e.target.dataset.field;
      if (field === 'receipt') {
        return;
      }
      if (index !== undefined && field) {
        if (field === 'date') {
          expenses[index].date = buildDateFromDay(e.target.value, expenses[index].date);
          if (!expenses[index].receipt) {
            expenses[index].receipt = getNextReceiptNumber();
          }
          // Datum wurde aktiv bearbeitet -> wieder einblenden
          expenses[index].hideDate = false;
          save();
          render();
        } else {
          expenses[index][field] = e.target.value;
          save();
          recalcTotals();
        }
      }
    });

    expenseBody.addEventListener('keydown', (e) => {
      const input = e.target;
      if (!input || input.tagName !== 'INPUT') return;
      if (e.key !== 'Enter') return;

      e.preventDefault();

      const indexStr = input.dataset.index;
      const field = input.dataset.field;
      if (indexStr === undefined || !field) return;
      const index = parseInt(indexStr, 10);
      if (isNaN(index) || index < 0 || index >= expenses.length) return;

      // Aktuellen Wert wie im change-Handler √ºbernehmen
      if (field === 'date') {
        expenses[index].date = buildDateFromDay(input.value, expenses[index].date);
        if (!expenses[index].receipt && expenses[index].date) {
          expenses[index].receipt = getNextReceiptNumber();
        }
        // Datum wurde aktiv bearbeitet -> wieder einblenden
        expenses[index].hideDate = false;
      } else {
        expenses[index][field] = input.value;
      }

      // Wenn kein Tag/keine Belegnummer vorhanden ist, Datum in dieser Zeile ausblenden,
      // sobald eine neue Zeile darunter erzeugt wird (Unterposition zum Beleg dar√ºber).
      const curParts = getDateParts(expenses[index].date);
      const hasDay = !!curParts.day;
      const hasReceipt = !!(expenses[index].receipt && String(expenses[index].receipt).trim());
      if (!hasDay && !hasReceipt) {
        expenses[index].hideDate = true;
      }

      // Neue Zeile direkt darunter einf√ºgen
      const newEntry = {
        date: "",
        amount: "",
        desc: "",
        receipt: ""
      };
      expenses.splice(index + 1, 0, newEntry);
      save();
      render();

      // Fokus in die entsprechende Spalte der neuen Zeile setzen
      setTimeout(() => {
        const rows = expenseBody.querySelectorAll('tr');
        if (!rows || rows.length <= index + 1) return;
        const newRow = rows[index + 1];
        if (!newRow) return;

        const target = newRow.querySelector('input[data-field="date"]');
        if (target) {
          target.focus();
          target.select();
        }
      }, 0);
    });

    const enterHint = document.getElementById('enterHint');

    function updateEnterHint(target) {
      if (!enterHint) return;
      if (target && target.tagName === 'INPUT' && target.dataset.field === 'desc') {
        enterHint.style.display = 'block';
      } else {
        enterHint.style.display = 'none';
      }
    }

    
const enterHintRow=document.getElementById('enterHintRow');

function updateEnterHintRow(target){
  if(!enterHintRow) return;
  if(target && target.tagName==='INPUT' && target.dataset.field==='desc'){
    enterHintRow.style.display='';
  } else {
    enterHintRow.style.display='none';
  }
}

expenseBody.addEventListener('focusin',(e)=>{updateEnterHintRow(e.target);});
expenseBody.addEventListener('focusout',(e)=>{updateEnterHintRow(null);});

expenseBody.addEventListener('focusin', (e) => {
      updateEnterHint(e.target);
    });

    expenseBody.addEventListener('focusout', (e) => {
      // Beim Verlassen des Eingabefeldes den Hinweis ausblenden
      updateEnterHint(null);
    });

    expenseBody.addEventListener('click', (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const index = parseInt(btn.dataset.index);

      if (btn.classList.contains('deleteBtn')) {
        expenses.splice(index, 1);
        save();
        render();
      }

      if (btn.classList.contains('insertBtn')) {
        const newEntry = {
          date: "",
          amount: "",
          desc: ""
        };
        expenses.splice(index + 1, 0, newEntry);
        save();
        render();
      }
    });

    function handleMonthYearChange() {
      currentKey = getCurrentKey();
      expenses = allExpenses[currentKey] || [{
        date: "",
        amount: "",
        desc: "",
        receipt: ""
      }];
      render();
      updateLockIcon();
      updateEditability();
    }

    if (monthSelect) {
      monthSelect.addEventListener('change', handleMonthYearChange);
    }
    if (yearSelect) {
      yearSelect.addEventListener('change', handleMonthYearChange);
    }

    const sortBtn = document.getElementById('sortBtn');
    if (sortBtn) sortBtn.addEventListener('click', (e) => {
      sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
      expenses.sort((a, b) => {
        return sortDirection === 'asc'
          ? (a.date || '').localeCompare(b.date || '')
          : (b.date || '').localeCompare(a.date || '');
      });
      e.target.textContent = 'Sortieren ' + (sortDirection === 'asc' ? '‚Üë' : '‚Üì');
      save();
      render();
      updateLockIcon();
      updateEditability();
    });

    document.getElementById('printBtn').addEventListener('click', () => {
      buildPrintArea();
      window.print();
    });

    document.getElementById('exportBtn').addEventListener('click', () => {
  const blob = new Blob([JSON.stringify(allExpenses, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;

  const defaultFilename = 'Ausgaben_Alle_Monate.json';
  const userFilename = prompt("Dateiname f√ºr den Export eingeben:", defaultFilename);
  if (!userFilename) {
    URL.revokeObjectURL(url);
    return;
  }
  const filename = userFilename.endsWith('.json') ? userFilename : `${userFilename}.json`;

  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
});

    document.getElementById('importBtn').addEventListener('click', () => {
      document.getElementById('importInput').click();
    });

    document.getElementById('importInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const imported = JSON.parse(reader.result);
          if (imported && typeof imported === 'object' && !Array.isArray(imported)) {
            // Neue Struktur: mehrere Monate
            Object.entries(imported).forEach(([key, list]) => {
              if (Array.isArray(list)) {
                allExpenses[key] = list;
              }
            });
            saveAll();
            currentKey = getCurrentKey();
            expenses = allExpenses[currentKey] || [{
              date: "",
              amount: "",
              desc: "",
              receipt: ""
            }];
            render();
            return;
          }

          if (Array.isArray(imported)) {
            expenses = imported.map(item => ({
              date: item.date || '',
              amount: item.amount || '',
              desc: item.desc || item.description || '',
              receipt: item.receipt || item.beleg || ''
            }));
            autoAssignReceiptsIfMissing();
            // Monat/Jahr anhand der geladenen Daten einstellen
            determineMonthFromExpenses();

            // Wichtig: currentKey neu berechnen (nachdem Monat/Jahr gesetzt wurden),
            // sonst wird in den falschen Monat gespeichert.
            const importedKey = getCurrentKey();
            if (importedKey) {
              currentKey = importedKey;
              allExpenses[currentKey] = expenses;
              saveAll();
            } else {
              // Fallback: altes Verhalten
              save();
            }

            render();
            updateLockIcon();
            updateEditability();
          } else {
            alert("Ung√ºltiges Format.");
          }
        } catch {
          alert("Fehler beim Import.");
        }
      };
      reader.readAsText(file);
      // Input zur√ºcksetzen, damit derselbe Dateiname erneut importiert werden kann
      e.target.value = '';
    });

    function formatEuro(value) {
      return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(value);
    }

    function load() {
      loadAll();
      initMonthSelector();
      currentKey = getCurrentKey();
      expenses = allExpenses[currentKey] || [{
        date: "",
        amount: "",
        desc: "",
        receipt: ""
      }];
      render();
      updateLockIcon();
      updateEditability();
    }

    window.onafterprint = () => {
      if (printArea) {
        printArea.innerHTML = "";
      }
    };

    // Start
document.getElementById('lockIcon').addEventListener('click', toggleLock);
    loadLocks();
    load();
    updateLockIcon();
    updateEditability();
  
    document.getElementById('excelExportBtn').addEventListener('click', () => {
      const wsData = [
        ["Beleg", "Datum", "Betrag (‚Ç¨)", "Beschreibung"]
      ];

      let total = 0;
      expenses.forEach(exp => {
        const amount = parseAmount(exp.amount);
        total += amount;
        wsData.push([
          exp.receipt || '',
          formatDateGerman(exp.date),
          amount,
          exp.desc || ''
        ]);
        wsData.push([]);
      });

    const netRaw = total / 1.19;
      const vatRaw = total - netRaw;

      // auf 2 Nachkommastellen runden
      const totalRounded = Math.round(total * 100) / 100;
      const netRounded = Math.round(netRaw * 100) / 100;
      const vatRounded = Math.round(vatRaw * 100) / 100;

      wsData.push([]);
      wsData.push(["Gesamtsumme (Brutto):", totalRounded]);
      wsData.push(["Nettobetrag:", netRounded]);
      wsData.push(["Mehrwertsteuer (19%):", vatRounded]);

      const worksheet = XLSX.utils.aoa_to_sheet(wsData);

      // Alle Zahlenzellen im Arbeitsblatt mit 2 Dezimalstellen formatieren
      Object.keys(worksheet).forEach((cellAddr) => {
        if (cellAddr[0] === '!') return;
        const cell = worksheet[cellAddr];
        if (typeof cell.v === 'number') {
          cell.z = '0.00';
        }
      });

      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "Ausgaben");

      const month = getSelectedMonthName();
      const year = getSelectedYear();
      const filename = `Ausgaben_${month}_${year || ''}.xlsx`;

      XLSX.writeFile(workbook, filename);
    });


    document.getElementById('clearAllBtn').addEventListener('click', () => {
      if (confirm("M√∂chtest du wirklich alle Daten l√∂schen?")) {
        expenses = [{
          date: "",
          amount: "",
          desc: "",
          receipt: ""
        }];
        save();
        render();
      }
    });</script>
</body>
</html>
